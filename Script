local UIS = game:GetService("UserInputService")
local TweenService = game:GetService("TweenService")
local RunService = game:GetService("RunService")
local CoreGui = game:GetService("CoreGui")
local Players = game:GetService("Players")
local plr = Players.LocalPlayer
local camera = workspace.CurrentCamera

local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "TOGA_ULTIMATE_V4"
ScreenGui.Parent = CoreGui
ScreenGui.ResetOnSpawn = false

local OpenBtn = Instance.new("TextButton", ScreenGui)
OpenBtn.Size = UDim2.new(0, 50, 0, 50)
OpenBtn.Position = UDim2.new(1, -70, 1, -70)
OpenBtn.BackgroundColor3 = Color3.fromRGB(10, 0, 0)
OpenBtn.Text = "</>"
OpenBtn.TextColor3 = Color3.fromRGB(255, 0, 0)
OpenBtn.Font = Enum.Font.Code
OpenBtn.TextSize = 18
OpenBtn.ZIndex = 5
Instance.new("UICorner", OpenBtn).CornerRadius = UDim.new(1, 0)

local IconStroke = Instance.new("UIStroke", OpenBtn)
IconStroke.Color = Color3.fromRGB(255, 0, 0)
IconStroke.Thickness = 1.5

task.spawn(function()
    while true do
        TweenService:Create(OpenBtn, TweenInfo.new(1, Enum.EasingStyle.Sine, Enum.EasingDirection.InOut, -1, true), {Rotation = 10}):Play()
        task.wait(2)
    end
end)

local MainFrame = Instance.new("Frame", ScreenGui)
MainFrame.BackgroundColor3 = Color3.fromRGB(5, 0, 0)
MainFrame.BackgroundTransparency = 0.1
MainFrame.Position = UDim2.new(1, 400, 1, -280)
MainFrame.Size = UDim2.new(0, 320, 0, 230)
MainFrame.ClipsDescendants = true
MainFrame.Visible = false
Instance.new("UICorner", MainFrame).CornerRadius = UDim.new(0, 15)

local UIStroke = Instance.new("UIStroke", MainFrame)
UIStroke.Thickness = 3
UIStroke.ApplyStrokeMode = Enum.ApplyStrokeMode.Border
local UIGradient = Instance.new("UIGradient", UIStroke)
UIGradient.Color = ColorSequence.new{
    ColorSequenceKeypoint.new(0, Color3.fromRGB(255, 0, 0)),
    ColorSequenceKeypoint.new(0.5, Color3.fromRGB(80, 0, 0)),
    ColorSequenceKeypoint.new(1, Color3.fromRGB(255, 0, 0))
}

local ParticleContainer = Instance.new("Frame", MainFrame)
ParticleContainer.Size = UDim2.new(1, 0, 1, 0)
ParticleContainer.BackgroundTransparency = 1
for i = 1, 15 do
    local dot = Instance.new("Frame", ParticleContainer)
    dot.Size = UDim2.new(0, 2, 0, 2)
    dot.BackgroundColor3 = Color3.fromRGB(255, 0, 0)
    dot.BackgroundTransparency = 0.5
    Instance.new("UICorner", dot).CornerRadius = UDim.new(1, 0)
    local function move()
        local target = UDim2.new(math.random(), 0, math.random(), 0)
        local t = TweenService:Create(dot, TweenInfo.new(math.random(3, 6)), {Position = target})
        t:Play() t.Completed:Connect(move)
    end
    dot.Position = UDim2.new(math.random(), 0, math.random(), 0)
    move()
end

local Title = Instance.new("TextLabel", MainFrame)
Title.Text = "TOGA ULTIMATE"
Title.Font = Enum.Font.GothamBlack
Title.TextSize = 22
Title.TextColor3 = Color3.fromRGB(255, 0, 0)
Title.Size = UDim2.new(1, 0, 0, 40)
Title.BackgroundTransparency = 1

local masterLock, npcLock, espPlayers, espNpcs, flying, flinging, noclip = false, false, false, false, false, false, false
local isHolding, lockTarget = false, nil
local Storage = {}
local flySpeed = 50
local ctrl = {f = 0, b = 0, l = 0, r = 0}

local function toggleBtn(btn, stroke, state, name)
    btn.Text = name .. (state and " [ON]" or " [OFF]")
    btn.TextColor3 = state and Color3.fromRGB(0, 255, 0) or Color3.fromRGB(255, 0, 0)
    stroke.Color = state and Color3.fromRGB(0, 255, 0) or Color3.fromRGB(150, 0, 0)
end

local function createCmdBtn(name, pos, callback)
    local btn = Instance.new("TextButton", MainFrame)
    btn.Text = name .. " [OFF]"
    btn.Font = Enum.Font.Code
    btn.TextSize = 10
    btn.TextColor3 = Color3.fromRGB(255, 0, 0)
    btn.BackgroundColor3 = Color3.fromRGB(12, 0, 0)
    btn.Size = UDim2.new(0, 130, 0, 26)
    btn.Position = pos
    local stroke = Instance.new("UIStroke", btn)
    stroke.Thickness = 1.2
    stroke.Color = Color3.fromRGB(150, 0, 0)
    Instance.new("UICorner", btn).CornerRadius = UDim.new(0, 6)
    btn.MouseButton1Click:Connect(function() callback(btn, stroke) end)
    return btn, stroke
end

createCmdBtn("LOCK PLAYERS", UDim2.new(0.05, 0, 0.25, 0), function(b, s) masterLock = not masterLock; toggleBtn(b, s, masterLock, "LOCK PLAYERS") end)
createCmdBtn("LOCK NPCs", UDim2.new(0.05, 0, 0.40, 0), function(b, s) npcLock = not npcLock; toggleBtn(b, s, npcLock, "LOCK NPCs") end)
createCmdBtn("ESP PLAYERS", UDim2.new(0.05, 0, 0.55, 0), function(b, s) espPlayers = not espPlayers; toggleBtn(b, s, espPlayers, "ESP PLAYERS") end)
createCmdBtn("ESP NPCs", UDim2.new(0.05, 0, 0.70, 0), function(b, s) espNpcs = not espNpcs; toggleBtn(b, s, espNpcs, "ESP NPCs") end)

local flyBtn, flyStr = createCmdBtn("FLY (F1/F2)", UDim2.new(0.53, 0, 0.25, 0), function(b, s) end)
createCmdBtn("WALK FLING", UDim2.new(0.53, 0, 0.40, 0), function(b, s)
    flinging = not flinging
    toggleBtn(b, s, flinging, "WALK FLING")
    task.spawn(function()
        while flinging and plr.Character do
            local hrp = plr.Character:FindFirstChild("HumanoidRootPart")
            if hrp then
                local oldV = hrp.Velocity
                hrp.Velocity = oldV * 10000 + Vector3.new(0, 10000, 0)
                RunService.RenderStepped:Wait()
                hrp.Velocity = oldV
            end
            RunService.Heartbeat:Wait()
        end
    end)
end)
local noclipBtn, noclipStr = createCmdBtn("NOCLIP (F3/F4)", UDim2.new(0.53, 0, 0.55, 0), function(b, s) end)

local isOpen = false
OpenBtn.MouseButton1Click:Connect(function()
    isOpen = not isOpen
    if isOpen then
        MainFrame.Visible = true
        OpenBtn.Text = "X"
        MainFrame:TweenPosition(UDim2.new(1, -340, 1, -250), "Out", "Back", 0.5, true)
    else
        OpenBtn.Text = "</>"
        MainFrame:TweenPosition(UDim2.new(1, 400, 1, -250), "In", "Quad", 0.4, true, function()
            if not isOpen then MainFrame.Visible = false end
        end)
    end
end)

RunService.Stepped:Connect(function()
    if noclip and plr.Character then
        for _, v in pairs(plr.Character:GetDescendants()) do
            if v:IsA("BasePart") then v.CanCollide = false end
        end
    end
end)

local function StartFly()
    if flying then return end
    flying = true
    toggleBtn(flyBtn, flyStr, true, "FLY (F1/F2)")
    task.spawn(function()
        local char = plr.Character or plr.CharacterAdded:Wait()
        local root = char:WaitForChild("HumanoidRootPart")
        local hum = char:WaitForChild("Humanoid")
        local bg = Instance.new("BodyGyro", root)
        bg.P = 9e4; bg.maxTorque = Vector3.new(9e9, 9e9, 9e9); bg.cframe = root.CFrame
        local bv = Instance.new("BodyVelocity", root)
        bv.velocity = Vector3.new(0,0.1,0); bv.maxForce = Vector3.new(9e9, 9e9, 9e9)
        while flying and char.Parent do
            hum.PlatformStand = true
            bv.velocity = ((camera.CFrame.LookVector * (ctrl.f + ctrl.b)) + ((camera.CFrame * CFrame.new(ctrl.l + ctrl.r, (ctrl.f + ctrl.b) * 0.2, 0).p) - camera.CFrame.p)) * flySpeed
            bg.cframe = camera.CFrame
            RunService.Heartbeat:Wait()
        end
        bg:Destroy(); bv:Destroy(); hum.PlatformStand = false
    end)
end

local function StopFly()
    flying = false
    toggleBtn(flyBtn, flyStr, false, "FLY (F1/F2)")
end

local function GetTargets()
    local t = {}
    for _, v in pairs(workspace:GetDescendants()) do
        if v:IsA("Humanoid") and v.Health > 0 then
            local char = v.Parent
            if char and char ~= plr.Character and char:IsA("Model") then
                local root = char:FindFirstChild("HumanoidRootPart") or char:FindFirstChild("Head") or char:FindFirstChild("Torso")
                if root then table.insert(t, char) end
            end
        end
    end
    return t
end

RunService.RenderStepped:Connect(function()
    UIGradient.Rotation = UIGradient.Rotation + 2
    if (masterLock or npcLock) and isHolding and lockTarget then
        camera.CFrame = CFrame.new(camera.CFrame.Position, lockTarget.Position)
    end
    
    local allCharacters = GetTargets()
    for _, char in pairs(allCharacters) do
        local isP = Players:GetPlayerFromCharacter(char)
        local show = (isP and espPlayers) or (not isP and espNpcs)
        local root = char:FindFirstChild("HumanoidRootPart") or char:FindFirstChild("Head")
        
        if show and root then
            if not Storage[char] then
                Storage[char] = {Box = Drawing.new("Square"), Label = Drawing.new("Text")}
                Storage[char].Box.Color = Color3.fromRGB(255, 0, 0); Storage[char].Box.Thickness = 1
                Storage[char].Label.Color = Color3.new(1,1,1); Storage[char].Label.Size = 13; Storage[char].Label.Outline = true; Storage[char].Label.Center = true
            end
            local pos, on = camera:WorldToViewportPoint(root.Position)
            Storage[char].Box.Visible = on; Storage[char].Label.Visible = on
            if on then
                local s = 2000/pos.Z
                Storage[char].Box.Size = Vector2.new(s, s*1.3)
                Storage[char].Box.Position = Vector2.new(pos.X-s/2, pos.Y-s/1.5)
                Storage[char].Label.Position = Vector2.new(pos.X, pos.Y - s/1.5 - 15)
                Storage[char].Label.Text = (char.Name ~= "" and char.Name) or "Entity"
            end
        elseif Storage[char] then
            Storage[char].Box.Visible = false; Storage[char].Label.Visible = false
        end
    end
end)

UIS.InputBegan:Connect(function(i, p)
    if not p and i.UserInputType == Enum.UserInputType.MouseButton2 then
        isHolding = true
        local dist = 500
        for _, char in pairs(GetTargets()) do
            local root = char:FindFirstChild("HumanoidRootPart") or char:FindFirstChild("Head")
            local targetIsPlayer = Players:GetPlayerFromCharacter(char)
            if root and ((masterLock and targetIsPlayer) or (npcLock and not targetIsPlayer)) then
                local screenPos, onScreen = camera:WorldToViewportPoint(root.Position)
                if onScreen then
                    local mag = (UIS:GetMouseLocation() - Vector2.new(screenPos.X, screenPos.Y)).Magnitude
                    if mag < dist then dist = mag; lockTarget = root end
                end
            end
        end
    elseif i.KeyCode == Enum.KeyCode.F1 then StartFly()
    elseif i.KeyCode == Enum.KeyCode.F2 then StopFly()
    elseif i.KeyCode == Enum.KeyCode.F3 then noclip = true; toggleBtn(noclipBtn, noclipStr, true, "NOCLIP (F3/F4)")
    elseif i.KeyCode == Enum.KeyCode.F4 then noclip = false; toggleBtn(noclipBtn, noclipStr, false, "NOCLIP (F3/F4)")
    elseif not p then
        if i.KeyCode == Enum.KeyCode.W then ctrl.f = 1
        elseif i.KeyCode == Enum.KeyCode.S then ctrl.b = -1
        elseif i.KeyCode == Enum.KeyCode.A then ctrl.l = -1
        elseif i.KeyCode == Enum.KeyCode.D then ctrl.r = 1 end
    end
end)

UIS.InputEnded:Connect(function(i)
    if i.UserInputType == Enum.UserInputType.MouseButton2 then isHolding = false; lockTarget = nil end
    if i.KeyCode == Enum.KeyCode.W then ctrl.f = 0
    elseif i.KeyCode == Enum.KeyCode.S then ctrl.b = 0
    elseif i.KeyCode == Enum.KeyCode.A then ctrl.l = 0
    elseif i.KeyCode == Enum.KeyCode.D then ctrl.r = 0 end
end)

local dragI, dStartI, sPosI
OpenBtn.InputBegan:Connect(function(i) if i.UserInputType == Enum.UserInputType.MouseButton1 then dragI = true; dStartI = i.Position; sPosI = OpenBtn.Position end end)
UIS.InputChanged:Connect(function(i) if dragI and i.UserInputType == Enum.UserInputType.MouseMovement then
    local delta = i.Position - dStartI
    OpenBtn.Position = UDim2.new(sPosI.X.Scale, sPosI.X.Offset + delta.X, sPosI.Y.Scale, sPosI.Y.Offset + delta.Y)
end end)
UIS.InputEnded:Connect(function(i) if i.UserInputType == Enum.UserInputType.MouseButton1 then dragI = false end end)
